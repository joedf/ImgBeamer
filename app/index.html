<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<title>ImgBeamer</title>

		<link rel="icon" href="src/img/favicon.ico" type="image/x-icon" />

		<link rel="stylesheet" href="src/3rd-party/jquery-ui-1.13.2.custom/jquery-ui.min.css">

		<link rel="stylesheet" href="src/css/style.css">
		<script src="src/3rd-party/konva/konva.js"></script>
		<script src="src/3rd-party/jquery-3.6.1.min.js"></script>
		<script src="src/3rd-party/jquery-ui-1.13.2.custom/jquery-ui.min.js"></script>
		<script src="src/3rd-party/dat.gui/dat.gui.min.js"></script>
		<script src="src/3rd-party/UTIF.js"></script>
		<script src="src/3rd-party/image-ms-ssim.js"></script>
	</head>
	<body>
		<div class="layout" id="main-container"></div>

		<div id="options-anchor">
			<div id="options">
				<div id="options-handle">&#9776;</div>
				<input type="file" id="_fileImgInput" accept="image/*" style="display: none;" />
			</div>
		</div>

		<div id="options-full-resample-anchor" style="display: none;">
			<div id="options-full-resample">
				<details>
					<summary>Full Resample Panel</summary>
					<table>
						<tr>
							<td>Cell Width</td>
							<td><input type="number" id="iCellW" placeholder="10"> px</td>
						</tr>
						<tr>
							<td>Cell Height</td>
							<td><input type="number" id="iCellH" placeholder="10"> px</td>
						</tr>
						<tr>
							<td>Spot Size X</td>
							<td><input type="number" id="iSpotX" placeholder="60"> %</td>
						</tr>
						<tr>
							<td>Spot Size Y</td>
							<td><input type="number" id="iSpotY" placeholder="60"> %</td>
						</tr>
						<tr>
							<td>Spot Angle (clockwise)</td>
							<td><input type="number" id="iSpotAngle" placeholder="0"> deg.</td>
						</tr>
						<tr>
							<td>Resample Fully</td>
							<td>
								<button id="generateFull">Generate</button>
								<svg id="loadspinner_full" class="load_spinner_svg"
									style="display:none"
									xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMidYMid" viewBox="0 0 16 16">
									<circle fill="none" stroke="#00d8ff" stroke-dasharray="28.274333882308138 11.42477796076938" cx="8" cy="8" r="6" stroke-width="2">
									<animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" keyTimes="0;1" values="0 8 8;360 8 8" dur="1s"></animateTransform>
									</circle>
								</svg>
							</td>
						</tr>
						<tr>
							<td>Status</td>
							<td>
								<pre id="status">-</pre>
							</td>
						</tr>
					</table>
				</details>
			</div>
		</div>

		<script src="src/utils.js"></script>
		<script src="src/drawsteps.js"></script>
		<script src="src/img_metrics.js"></script>
		<script src="src/main.js"></script>

		<script>
			const gui = new dat.GUI({autoPlace: false});
			var G_GUI_Controller = new function() {
				this.pixelCountX = 8;
				this.pixelCountY = 8;
				this.brightness = 0;
				this.contrast = 0;
				this.digitalMag = "1.00x";
				this.advancedMode = false;
				this.updateViews = function(){
					G_UpdateVirtualSEMConfig();
					G_UpdateResampled();
					G_Update_GroundTruth();
					G_Update_InfoDisplays();
				};
				this.updateFilters = function(){ G_UpdateFilters(); },
				this.resetBC = function(){
					let cGui = G_GUI_Controller.controls;
					cGui.brightness.setValue(0);
					cGui.contrast.setValue(0);
					G_UpdateFilters();
				},
				this.groundTruthImg = 'grains2tl.png';
				this.pause_vSEM = G_VSEM_PAUSED;
				this.doImageMetric = G_IMG_METRIC_ENABLED;
				this.imageMetricAlgo = 'iNRMSE';
				this.exportResultImg = function(){ exportResultImage(); };
				this.importImage = function(){
					// getInputImage();
					$('#_fileImgInput').click();
				};
				this.aboutMessage = function(){ Utils.ShowAboutMessage(); };
				this.pixelSize_nm = 500; // nm/px default;
				this.previewOpacity = 0.4;
				this.showRuler = false;
				this.controls = {};
			};
			
			var gui_ip = gui.addFolder('Imaging Parameters');
			gui_ip.add(G_GUI_Controller, 'pixelCountX', 1, 64, 1).onChange(G_GUI_Controller.updateViews);
			gui_ip.add(G_GUI_Controller, 'pixelCountY', 1, 64, 1).onChange(G_GUI_Controller.updateViews);
			G_GUI_Controller.controls.brightness = gui_ip.add(
				G_GUI_Controller, 'brightness', -1, 1, 0.01).onChange(G_GUI_Controller.updateFilters);
			G_GUI_Controller.controls.contrast = gui_ip.add(
				G_GUI_Controller, 'contrast', -100, 100, 0.1).onChange(G_GUI_Controller.updateFilters);
			gui_ip.add(G_GUI_Controller, 'resetBC').name('Reset Brightness / Contrast');
			gui_ip.add(G_GUI_Controller, 'digitalMag').listen();
			G_GUI_Controller.controls.pixelSize_nm = gui_ip
			.add(G_GUI_Controller, 'pixelSize_nm', 1, 1000, 1).onChange(function(){
				G_GUI_Controller.updateViews();
				G_UpdateRuler();
			});
			gui_ip.add(G_GUI_Controller, 'showRuler').onChange(function(){
				G_UpdateRuler();
			});
			gui_ip.open();

			var gui_do = gui.addFolder('Display Options');
			gui_do.add(G_GUI_Controller, 'advancedMode').onChange(function(){
				Utils.updateAdvancedMode();
			});
			gui_do.add(G_GUI_Controller, 'pause_vSEM').onChange(function(){
				G_VSEM_PAUSED = G_GUI_Controller.pause_vSEM;
			});
			gui_do.add(G_GUI_Controller, 'previewOpacity', 0, 1, 0.01).onChange(function(){
				G_UpdateResampled();
			});
			gui_do.add(G_GUI_Controller, 'doImageMetric').onChange(function(){
				G_IMG_METRIC_ENABLED = G_GUI_Controller.doImageMetric;
				G_update_ImgMetrics();
			});
			gui_do.add(G_GUI_Controller, 'imageMetricAlgo', G_IMG_METRICS);
			// gui.add(G_GUI_Controller, 'updateViews');

			var gui_io = gui.addFolder('Input / Export Image');
			gui_io.add(G_GUI_Controller, 'groundTruthImg', G_PRELOADED_IMAGES).listen().onChange(function(){
				var fname = Utils.getGroundtruthImage();
				if (fname.length > 0) {
					G_INPUT_IMAGE = G_PRELOADED_IMAGES_ROOT + fname;
					console.log("Ground Truth Image changed to: "+G_INPUT_IMAGE);
					$(document.body).trigger('OnGroundtruthImageChange');
				}
			});
			gui_io.add(G_GUI_Controller, 'importImage');
			gui_io.add(G_GUI_Controller, 'exportResultImg');
			var aboutBtn = gui.add(G_GUI_Controller, 'aboutMessage');
			aboutBtn.name("About " + G_APP_NAME + " / Credits");
			gui_io.open();

			$("#options").append(gui.domElement).draggable({
				// containment: 'body',
				handle: '#options-handle',
			});

			// used to auto-name the export files with a counter
			var G_Export_img_count = 0;
			var stageFinal = stages[stages.length - 1];
			function exportResultImage(){
				// Export image as file download
				// https://konvajs.org/docs/data_and_serialization/High-Quality-Export.html

				// get the image without the row/draw indicator
				var finalImage = Utils.getVirtualSEM_KonvaImage(stageFinal);
				
				// export the image
				var url = finalImage.toDataURL({pixelRatio:2});
				var filename = Utils.GetSuggestedFileName("result_image",++G_Export_img_count);
				Utils.downloadURI(url, filename);
			}

			$('#_fileImgInput').change(function(e){
				// https://stackoverflow.com/a/34840295/883015
				var file    = this.files[0];
				var reader  = new FileReader();

				reader.onloadend = function () {
					console.log("Ground Truth Image changed to: "+file.name);

					// clear selection in the combobox for included images
					G_GUI_Controller.groundTruthImg = '';

					G_INPUT_IMAGE = reader.result; // returns a data base64 url
					// G_INPUT_IMAGE = URL.createObjectURL(file); // makes a blob:// url
					$(document.body).trigger('OnGroundtruthImageChange');
				}

				if (file) {
					reader.readAsDataURL(file);
				} else {
					console.log('Imported image selection cleared.');
					// preview.src = "";
				}
			});

			if (G_DEBUG) {
				$('#options-full-resample-anchor').show();
			}

			$('#generateFull').click(function(e){
				$('#loadspinner_full').show();
				
				setTimeout(function(){
					ResampleFullImage();
					$('#loadspinner_full').hide();
				}, 250);
			});

			// Preload the larger image files in the background
			// without blocking the UI for improved responsiveness
			window.addEventListener('load', function(){
				// https://stackoverflow.com/a/59861857/883015
				// var images = G_PRELOADED_IMAGES;
				var images = ['APT_needle.png', 'tephra_448nm.png', 'tephra_200nm.png'];
				var preload = '';
				for(let i = 0; i < images.length; i++) {
					preload += '<link rel="preload" href="' + G_PRELOADED_IMAGES_ROOT
					+ images[i] + '" as="image">\n';
				}
				$('head').append(preload);
			});
		</script>
	</body>
</html>