<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<title>ImageProbeSampler</title>
		
		<link rel="stylesheet" href="src/css/style.css">
		<script src="src/3rd-party/konva/konva.js"></script>
		<script src="src/3rd-party/jquery-3.6.1.min.js"></script>
		<script src="src/3rd-party/jquery-ui-1.13.2/jquery-ui.min.js"></script>
	</head>
	<body>
		<div class="layout" id="main-container"></div>

		<div id="options-anchor">
			<div id="options">
				<details open>
					<summary>Configuration Panel</summary>
					<table>
						<tr>
							<td>Rows</td>
							<td><input type="number" id="iRows" placeholder="8"></td>
						</tr>
						<tr>
							<td>Columns</td>
							<td><input type="number" id="iCols" placeholder="8"></td>
						</tr>
						<!-- Using requestAnimationFrame() instead of timers for now -->
						<tr style="display: none;">
							<td>Refresh delay (ms)</td>
							<td><input type="number" id="iDelaySEM" placeholder="10"></td>
						</tr>
						<tr>
							<td>Ground Truth Image</td>
							<td>
								<select id="sb_groundtruthImage" name="sb_groundtruthImage" title="Ground Truth Image">
									<option value="src/testimages/grains1.png">grains1.png</option>
									<option value="src/testimages/grains1b.png">grains1b.png</option>
									<option value="src/testimages/grains1c.png">grains1c.png</option>
									<option value="src/testimages/grains2.png">grains2.png</option>
									<option value="src/testimages/grains2c.png">grains2c.png</option>
									<option value="src/testimages/grains2tl.png" selected>grains2tl.png</option>
								</select>
							</td>
						</tr>
						<tr>
							<td><button id="generateFinal">Generate preview</button></td>
							<td>
								<button id="openInNewTab">Open in new tab</button>
								<svg id="loadspinner" class="load_spinner_svg"
									style="display:none"
									xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMidYMid" viewBox="0 0 16 16">
									<circle fill="none" stroke="#00d8ff" stroke-dasharray="28.274333882308138 11.42477796076938" cx="8" cy="8" r="6" stroke-width="2">
									<animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" keyTimes="0;1" values="0 8 8;360 8 8" dur="1s"></animateTransform>
									</circle>
								</svg>
							</td>
						</tr>
					</table>
				</details>

				<details>
					<summary>Full Resample Panel</summary>
					<table>
						<tr>
							<td>Cell Width</td>
							<td><input type="number" id="iCellW" placeholder="10"> px</td>
						</tr>
						<tr>
							<td>Cell Height</td>
							<td><input type="number" id="iCellH" placeholder="10"> px</td>
						</tr>
						<tr>
							<td>Spot Size X</td>
							<td><input type="number" id="iSpotX" placeholder="60"> %</td>
						</tr>
						<tr>
							<td>Spot Size Y</td>
							<td><input type="number" id="iSpotY" placeholder="60"> %</td>
						</tr>
						<tr>
							<td>Spot Angle (clockwise)</td>
							<td><input type="number" id="iSpotAngle" placeholder="0"> deg.</td>
						</tr>
						<tr>
							<td>Resample Fully</td>
							<td>
								<button id="generateFull">Generate</button>
								<svg id="loadspinner_full" class="load_spinner_svg"
									style="display:none"
									xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMidYMid" viewBox="0 0 16 16">
									<circle fill="none" stroke="#00d8ff" stroke-dasharray="28.274333882308138 11.42477796076938" cx="8" cy="8" r="6" stroke-width="2">
									<animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" keyTimes="0;1" values="0 8 8;360 8 8" dur="1s"></animateTransform>
									</circle>
								</svg>
							</td>
						</tr>
						<tr>
							<td>Status</td>
							<td>
								<pre id="status">-</pre>
							</td>
						</tr>
					</table>
				</details>
				
				<details>
					<summary style="cursor: pointer; user-select: none;">References or people to look at...</summary>
					<ul>
						<li><a href="https://www.physik.hu-berlin.de/en/sem/software/software_qstem">sem/software/software_qstem</a></li>
						<li><a href="https://scialli.utk.edu/david-joy-retires/">david-joy-retires</a></li>
						<li><a href="https://sunypoly.edu/faculty-and-staff/eric-lifshin.html">eric-lifshin.html</a></li>
						<li><a href="https://www.nist.gov/people/andras-e-vladar">andras-e-vladar</a></li>
						<li><a href="https://www.nist.gov/publications/assessing-scanning-electron-microscopy-stereophotogrammetry-algorithms-virtual-test">algorithms-virtual-test</a></li>
						<li><a href="https://codepen.io/joedf/pen/VwxmXOx?editors=1010">PixiJS.Composite.Operation.Test.01</a></li>
					</ul>
				</details>
			</div>
		</div>

		<script src="src/utils.js"></script>
		<script src="src/drawsteps.js"></script>
		<script src="src/main.js"></script>

		<script>
			$("#options").draggable();

			var stageFinal = stages[stages.length - 1];

			var doGenerateSubRegion = function(e){
				$('#loadspinner').show();
				
				G_UpdateVirtualSEMConfig();
				
				setTimeout(function(){
					G_UpdateResampled(false);
					$('#loadspinner').hide();
				}, 250);
			};

			$('#iRows, #iCols, #iDelaySEM').keypress(function(e){
				if ( e.which == 13 ) {
					e.preventDefault();
					doGenerateSubRegion();
				}
			});

			$('#sb_groundtruthImage').on('change', function(e){
				INPUT_IMAGE = getGroundtruthImage();
				console.log("Ground Truth Image changed to: "+INPUT_IMAGE);
				$(document.body).trigger('OnGroundtruthImageChange');
			});

			$('#generateFinal').click(doGenerateSubRegion);
			$('#openInNewTab').click(function(e){
				var url = stageFinal.toDataURL({pixelRatio:2});
				window.open(url, '_blank').focus();
			});

			$('#generateFull').click(function(e){
				$('#loadspinner_full').show();
				
				setTimeout(function(){
					ResampleFullImage();
					$('#loadspinner_full').hide();
				}, 250);
			});
		</script>
	</body>
</html>